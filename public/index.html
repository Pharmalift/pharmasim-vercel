<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PharmaSim Pro | Pharmalift Solutions</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: linear-gradient(135deg, #0f172a, #1e293b); min-height: 100vh; color: #f8fafc; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        header { display: flex; justify-content: space-between; align-items: center; padding: 20px 0; border-bottom: 1px solid rgba(255,255,255,0.1); margin-bottom: 30px; }
        .logo { display: flex; align-items: center; gap: 12px; }
        .logo-icon { width: 50px; height: 50px; background: linear-gradient(135deg, #3b82f6, #8b5cf6); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 28px; }
        .logo h1 { font-size: 24px; }
        .logo h1 span { color: #3b82f6; }
        .badge-pro { background: linear-gradient(135deg, #f59e0b, #d97706); padding: 4px 10px; border-radius: 6px; font-size: 11px; font-weight: 700; margin-left: 8px; }
        .status-badge { padding: 8px 16px; border-radius: 20px; font-size: 12px; font-weight: 600; background: rgba(139,92,246,0.2); color: #a78bfa; }
        .category-title { font-size: 16px; margin: 32px 0 16px; padding-bottom: 10px; border-bottom: 1px solid rgba(255,255,255,0.08); color: #e2e8f0; }
        .category-title:first-of-type { margin-top: 0; }
        .section-title { font-size: 20px; font-weight: 700; margin: 40px 0 8px; padding: 12px 0; border-bottom: 2px solid rgba(255,255,255,0.15); color: #f8fafc; }
        .section-title:first-of-type { margin-top: 0; }
        .scenario-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 16px; margin-bottom: 20px; }
        .scenario-card { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 16px; padding: 20px; cursor: pointer; transition: all 0.3s; }
        .scenario-card:hover { background: rgba(255,255,255,0.08); border-color: #3b82f6; transform: translateY(-2px); }
        .scenario-card .avatar { width: 52px; height: 52px; background: linear-gradient(135deg, #fbbf24, #f59e0b); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 26px; margin-bottom: 12px; }
        .scenario-card h3 { font-size: 16px; margin-bottom: 6px; }
        .scenario-card p { font-size: 12px; color: #94a3b8; line-height: 1.4; }
        .game-container { display: none; grid-template-columns: 1fr 320px; gap: 24px; }
        .game-container.active { display: grid; }
        .chat-panel { background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.1); border-radius: 20px; overflow: hidden; }
        .chat-header { background: linear-gradient(135deg, #3b82f6, #8b5cf6); padding: 20px; display: flex; align-items: center; gap: 16px; }
        .chat-header .avatar { width: 50px; height: 50px; background: rgba(255,255,255,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 26px; }
        .chat-header h3 { font-size: 18px; }
        .chat-header p { font-size: 12px; opacity: 0.8; }
        .messages { height: 400px; overflow-y: auto; padding: 20px; background: #0f172a; }
        .message { display: flex; gap: 12px; margin-bottom: 16px; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .message.pharmacist { flex-direction: row-reverse; }
        .message .avatar { width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 18px; flex-shrink: 0; }
        .message.patient .avatar { background: #fbbf24; }
        .message.pharmacist .avatar { background: #3b82f6; }
        .message .bubble { max-width: 70%; padding: 12px 16px; border-radius: 16px; font-size: 14px; line-height: 1.5; }
        .message.patient .bubble { background: rgba(255,255,255,0.08); }
        .message.pharmacist .bubble { background: #3b82f6; }
        .typing .dots { display: flex; gap: 4px; padding: 12px 16px; background: rgba(255,255,255,0.08); border-radius: 16px; }
        .typing .dots span { width: 8px; height: 8px; background: #64748b; border-radius: 50%; animation: bounce 1.4s infinite ease-in-out both; }
        .typing .dots span:nth-child(1) { animation-delay: -0.32s; }
        .typing .dots span:nth-child(2) { animation-delay: -0.16s; }
        @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }
        .input-area { padding: 20px; background: rgba(255,255,255,0.02); border-top: 1px solid rgba(255,255,255,0.1); }
        .suggestions { display: flex; gap: 8px; margin-bottom: 12px; flex-wrap: wrap; }
        .suggestions button { padding: 8px 12px; background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.1); border-radius: 20px; font-size: 11px; color: #94a3b8; cursor: pointer; }
        .suggestions button:hover { background: rgba(59,130,246,0.2); border-color: #3b82f6; color: #60a5fa; }
        .input-row { display: flex; gap: 12px; }
        .input-row input { flex: 1; padding: 14px 18px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; color: #f8fafc; font-size: 14px; }
        .input-row input:focus { outline: none; border-color: #3b82f6; }
        .input-row input::placeholder { color: #64748b; }
        .input-row button { padding: 14px 24px; background: linear-gradient(135deg, #3b82f6, #8b5cf6); border: none; border-radius: 12px; color: white; font-weight: 600; cursor: pointer; }
        .input-row button:disabled { opacity: 0.5; }
        .actions { display: flex; justify-content: space-between; margin-top: 12px; }
        .back-btn, .end-btn { padding: 10px; background: transparent; border: none; color: #64748b; font-size: 13px; cursor: pointer; }
        .end-btn { color: #f87171; }
        .side-panel { display: flex; flex-direction: column; gap: 16px; }
        .panel-card { background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.1); border-radius: 16px; padding: 20px; }
        .panel-card h3 { font-size: 14px; color: #94a3b8; margin-bottom: 12px; }
        .score-value { font-size: 32px; font-weight: 700; color: #4ade80; }
        .score-bar-bg { height: 8px; background: rgba(255,255,255,0.1); border-radius: 4px; margin-top: 12px; }
        .score-bar { height: 100%; background: #4ade80; border-radius: 4px; transition: width 0.5s; }
        footer { text-align: center; padding: 40px; color: #475569; font-size: 12px; }
        @media (max-width: 900px) { .game-container.active { grid-template-columns: 1fr; } }
        .login-screen { display: flex; justify-content: center; align-items: center; min-height: 60vh; }
        .login-card { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 20px; padding: 40px; max-width: 420px; width: 100%; text-align: center; }
        .login-card h2 { font-size: 24px; margin-bottom: 8px; }
        .login-card .subtitle { color: #94a3b8; margin-bottom: 24px; font-size: 14px; }
        .login-card input { width: 100%; padding: 16px; background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.15); border-radius: 12px; color: #f8fafc; font-size: 20px; text-align: center; letter-spacing: 3px; font-family: monospace; margin-bottom: 16px; }
        .login-card input:focus { outline: none; border-color: #3b82f6; }
        .login-card input::placeholder { color: #475569; letter-spacing: 2px; font-size: 16px; }
        .btn-login { width: 100%; padding: 14px; background: linear-gradient(135deg, #3b82f6, #8b5cf6); border: none; border-radius: 12px; color: white; font-size: 16px; font-weight: 600; cursor: pointer; }
        .btn-login:disabled { opacity: 0.5; cursor: not-allowed; }
        .login-error { color: #f87171; font-size: 13px; margin-bottom: 12px; display: none; }
        .header-right { display: flex; align-items: center; gap: 12px; }
        .user-badge { padding: 8px 16px; border-radius: 20px; font-size: 12px; font-weight: 600; background: rgba(74,222,128,0.2); color: #4ade80; }
        .btn-logout { padding: 8px 12px; background: rgba(248,113,113,0.1); border: 1px solid rgba(248,113,113,0.2); border-radius: 8px; color: #f87171; font-size: 12px; cursor: pointer; }
        .btn-logout:hover { background: rgba(248,113,113,0.2); }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">
                <div class="logo-icon">üíä</div>
                <div><h1>Pharma<span>Sim</span><span class="badge-pro">PRO</span></h1></div>
            </div>
            <div class="header-right">
                <div class="status-badge">ü§ñ Propuls√© par Claude AI</div>
                <div id="userBadge" class="user-badge" style="display:none;"></div>
                <button id="logoutBtn" class="btn-logout" style="display:none;" onclick="handleLogout()">D√©connexion</button>
            </div>
        </header>
        <div id="loginScreen" class="login-screen">
            <div class="login-card">
                <div style="font-size:48px;margin-bottom:16px;">üíä</div>
                <h2>PharmaSim Pro</h2>
                <p class="subtitle">Entrez votre code d'acc√®s PharmaLift</p>
                <input type="text" id="accessCode" placeholder="XXXX-XXXX-XXXX" maxlength="14" oninput="formatCodeInput(this)" onkeypress="if(event.key==='Enter')handleLogin()">
                <div id="loginError" class="login-error"></div>
                <button class="btn-login" id="loginBtn" onclick="handleLogin()">Acc√©der aux simulations</button>
                <p style="margin-top:16px;font-size:11px;color:#475569;">Code fourni par votre formateur PharmaLift</p>
            </div>
        </div>
        <div id="scenarioSelection" style="display:none;">
            <h2 style="margin-bottom:24px;">Choisissez un sc√©nario</h2>

            <h2 class="section-title">üè• Sc√©narios Patients</h2>

            <h3 class="category-title">üî¥ Risques critiques</h3>
            <div class="scenario-grid">
                <div class="scenario-card" onclick="selectScenario('douleur_thoracique')">
                    <div class="avatar" style="background:linear-gradient(135deg,#ef4444,#dc2626);">‚ö†Ô∏è</div>
                    <h3>M. Durand</h3>
                    <p>45 ans ‚Ä¢ Douleur thoracique. Signes d'alerte cardiaque √† rep√©rer !</p>
                </div>
                <div class="scenario-card" onclick="selectScenario('femme_enceinte_medicaments')">
                    <div class="avatar" style="background:linear-gradient(135deg,#f472b6,#ec4899);">ü§∞</div>
                    <h3>Mme Laurent</h3>
                    <p>29 ans ‚Ä¢ Enceinte avec naus√©es. A pris un AINS sans le savoir.</p>
                </div>
                <div class="scenario-card" onclick="selectScenario('personne_agee_polymediquee')">
                    <div class="avatar" style="background:linear-gradient(135deg,#a78bfa,#7c3aed);">üëµ</div>
                    <h3>Mme Mercier</h3>
                    <p>82 ans ‚Ä¢ 12 m√©dicaments, confuse. Iatrog√©nie et chutes √† d√©tecter.</p>
                </div>
                <div class="scenario-card" onclick="selectScenario('intoxication_enfant')">
                    <div class="avatar" style="background:linear-gradient(135deg,#ef4444,#b91c1c);">üÜò</div>
                    <h3>Mme Girard</h3>
                    <p>Enfant 2 ans a aval√© des m√©dicaments. Gestion urgence toxicologique.</p>
                </div>
            </div>

            <h3 class="category-title">üü† Conseil sp√©cialis√©</h3>
            <div class="scenario-grid">
                <div class="scenario-card" onclick="selectScenario('mme_dubois')">
                    <div class="avatar">üë©‚Äçü¶≥</div>
                    <h3>Mme Dubois</h3>
                    <p>58 ans ‚Ä¢ Ordonnance + maux de t√™te. Interactions cach√©es.</p>
                </div>
                <div class="scenario-card" onclick="selectScenario('aromatherapie')">
                    <div class="avatar" style="background:linear-gradient(135deg,#34d399,#10b981);">üåø</div>
                    <h3>Mme Martin</h3>
                    <p>42 ans ‚Ä¢ Huiles essentielles stress/sommeil. Anxiolytique cach√©.</p>
                </div>
                <div class="scenario-card" onclick="selectScenario('phytotherapie_prostate')">
                    <div class="avatar" style="background:linear-gradient(135deg,#22c55e,#16a34a);">üå±</div>
                    <h3>M. Bernard</h3>
                    <p>62 ans ‚Ä¢ Prostate, veut du naturel. Traitement arr√™t√©, PSA non suivi.</p>
                </div>
                <div class="scenario-card" onclick="selectScenario('micronutrition_fatigue')">
                    <div class="avatar" style="background:linear-gradient(135deg,#fb923c,#f97316);">ü•ó</div>
                    <h3>Mme Faure</h3>
                    <p>35 ans ‚Ä¢ Fatigue intense, jeune maman. Carences cach√©es.</p>
                </div>
                <div class="scenario-card" onclick="selectScenario('menopause')">
                    <div class="avatar" style="background:linear-gradient(135deg,#f9a8d4,#ec4899);">üå∏</div>
                    <h3>Mme Blanchard</h3>
                    <p>52 ans ‚Ä¢ M√©nopause, refuse le THS. Ant√©c√©dent familial cancer.</p>
                </div>
                <div class="scenario-card" onclick="selectScenario('detox_drainage')">
                    <div class="avatar" style="background:linear-gradient(135deg,#86efac,#22c55e);">üßÉ</div>
                    <h3>Mme Petit</h3>
                    <p>28 ans ‚Ä¢ Cure d√©tox Instagram. Possible TCA √† d√©pister.</p>
                </div>
                <div class="scenario-card" onclick="selectScenario('sport_recuperation')">
                    <div class="avatar" style="background:linear-gradient(135deg,#60a5fa,#3b82f6);">üèÉ</div>
                    <h3>Thomas</h3>
                    <p>32 ans ‚Ä¢ Marathon, courbatures. Hydratation et progressivit√©.</p>
                </div>
            </div>

            <h3 class="category-title">üü° Populations sp√©cifiques</h3>
            <div class="scenario-grid">
                <div class="scenario-card" onclick="selectScenario('pediatrie')">
                    <div class="avatar" style="background:linear-gradient(135deg,#60a5fa,#3b82f6);">üë∂</div>
                    <h3>M. Petit (p√®re)</h3>
                    <p>Enfant 3 ans fi√©vreux. Convulsion f√©brile √† d√©tecter.</p>
                </div>
                <div class="scenario-card" onclick="selectScenario('bebe_coliques')">
                    <div class="avatar" style="background:linear-gradient(135deg,#fbbf24,#f59e0b);">üë∂</div>
                    <h3>Mme Dupont</h3>
                    <p>B√©b√© 3 semaines, coliques. Baby blues maternel √† d√©pister.</p>
                </div>
                <div class="scenario-card" onclick="selectScenario('personne_agee_isolee')">
                    <div class="avatar" style="background:linear-gradient(135deg,#94a3b8,#64748b);">üßì</div>
                    <h3>M. Martin</h3>
                    <p>78 ans ‚Ä¢ Confus, isol√©. Fragilit√© et risque domestique.</p>
                </div>
                <div class="scenario-card" onclick="selectScenario('femme_enceinte_rhume')">
                    <div class="avatar" style="background:linear-gradient(135deg,#fca5a5,#f87171);">ü§ß</div>
                    <h3>Mme Chen</h3>
                    <p>34 ans ‚Ä¢ Enceinte, rhume et fi√®vre. Autom√©dication √† risque.</p>
                </div>
                <div class="scenario-card" onclick="selectScenario('patient_diabetique')">
                    <div class="avatar" style="background:linear-gradient(135deg,#c084fc,#a855f7);">üíâ</div>
                    <h3>M. Kon√©</h3>
                    <p>58 ans ‚Ä¢ Diab√©tique, veut un sirop. Adaptation au terrain.</p>
                </div>
            </div>

            <h3 class="category-title">üü¢ Dermatologie comptoir</h3>
            <div class="scenario-grid">
                <div class="scenario-card" onclick="selectScenario('dermato')">
                    <div class="avatar" style="background:linear-gradient(135deg,#f472b6,#ec4899);">üíÜ</div>
                    <h3>Emma</h3>
                    <p>16 ans ‚Ä¢ Acn√©. Produits internet dangereux.</p>
                </div>
                <div class="scenario-card" onclick="selectScenario('eczema_bebe')">
                    <div class="avatar" style="background:linear-gradient(135deg,#fbbf24,#f59e0b);">üëß</div>
                    <h3>Mme Dubois-Morel</h3>
                    <p>B√©b√© 8 mois, ecz√©ma. Corticophobie √† lever.</p>
                </div>
                <div class="scenario-card" onclick="selectScenario('mycose_pied')">
                    <div class="avatar" style="background:linear-gradient(135deg,#34d399,#10b981);">ü¶∂</div>
                    <h3>M. Fernandez</h3>
                    <p>42 ans ‚Ä¢ Mycose pied, piscine. Diab√®te non signal√©.</p>
                </div>
                <div class="scenario-card" onclick="selectScenario('poux')">
                    <div class="avatar" style="background:linear-gradient(135deg,#fb923c,#f97316);">ü™≥</div>
                    <h3>Mme Martinez</h3>
                    <p>3 enfants, poux r√©cidivants. Traitement incomplet.</p>
                </div>
                <div class="scenario-card" onclick="selectScenario('coup_de_soleil')">
                    <div class="avatar" style="background:linear-gradient(135deg,#fbbf24,#f59e0b);">‚òÄÔ∏è</div>
                    <h3>Lucas</h3>
                    <p>22 ans ‚Ä¢ Coup de soleil s√©v√®re. M√©dicament photosensibilisant.</p>
                </div>
                <div class="scenario-card" onclick="selectScenario('herpes_labial')">
                    <div class="avatar" style="background:linear-gradient(135deg,#f9a8d4,#ec4899);">üíã</div>
                    <h3>Julie</h3>
                    <p>27 ans ‚Ä¢ Herp√®s r√©cidivant. Contagiosit√© et pr√©vention.</p>
                </div>
            </div>

            <h3 class="category-title">üîµ Situations d√©licates</h3>
            <div class="scenario-grid">
                <div class="scenario-card" onclick="selectScenario('veterinaire')">
                    <div class="avatar" style="background:linear-gradient(135deg,#a78bfa,#7c3aed);">üê±</div>
                    <h3>Mme Rossi</h3>
                    <p>55 ans ‚Ä¢ Chat malade. Advil donn√© √† l'animal.</p>
                </div>
                <div class="scenario-card" onclick="selectScenario('contraception_urgence')">
                    <div class="avatar" style="background:linear-gradient(135deg,#60a5fa,#3b82f6);">üíä</div>
                    <h3>Claire</h3>
                    <p>19 ans ‚Ä¢ Contraception d'urgence. Oublis r√©currents.</p>
                </div>
                <div class="scenario-card" onclick="selectScenario('test_grossesse_positif')">
                    <div class="avatar" style="background:linear-gradient(135deg,#c4b5fd,#8b5cf6);">ü•∫</div>
                    <h3>In√®s</h3>
                    <p>23 ans ‚Ä¢ Test positif, en pleurs. √âcoute et orientation.</p>
                </div>
                <div class="scenario-card" onclick="selectScenario('sevrage_tabac')">
                    <div class="avatar" style="background:linear-gradient(135deg,#94a3b8,#64748b);">üö¨</div>
                    <h3>M. Leroy</h3>
                    <p>55 ans ‚Ä¢ Veut arr√™ter de fumer. BPCO, forte d√©pendance.</p>
                </div>
                <div class="scenario-card" onclick="selectScenario('dependance_benzodiazepines')">
                    <div class="avatar" style="background:linear-gradient(135deg,#fca5a5,#f87171);">üò∞</div>
                    <h3>Mme Roux</h3>
                    <p>65 ans ‚Ä¢ Demande Lexomil sans ordonnance. D√©pendance.</p>
                </div>
                <div class="scenario-card" onclick="selectScenario('patient_agressif')">
                    <div class="avatar" style="background:linear-gradient(135deg,#ef4444,#dc2626);">üò†</div>
                    <h3>M. Sanchez</h3>
                    <p>40 ans ‚Ä¢ Rupture m√©dicament. D√©sescalade et empathie.</p>
                </div>
                <div class="scenario-card" onclick="selectScenario('suspicion_maltraitance')">
                    <div class="avatar" style="background:linear-gradient(135deg,#475569,#334155);">üíî</div>
                    <h3>Tim√©o (7 ans)</h3>
                    <p>Bleus r√©currents. Observation et protocole signalement.</p>
                </div>
            </div>

            <h2 class="section-title">üíº Sc√©narios Management</h2>

            <h3 class="category-title">üü§ Management & Gestion d'Officine</h3>
            <div class="scenario-grid">
                <div class="scenario-card" onclick="selectScenario('delegue_insistant')">
                    <div class="avatar" style="background:linear-gradient(135deg,#78716c,#57534e);">üëî</div>
                    <h3>Marc</h3>
                    <p>D√©l√©gu√© Pharma G√©n√©rix ‚Ä¢ Offre agressive √† analyser.</p>
                </div>
                <div class="scenario-card" onclick="selectScenario('conflit_equipe')">
                    <div class="avatar" style="background:linear-gradient(135deg,#f87171,#ef4444);">üò§</div>
                    <h3>Sophie</h3>
                    <p>Pr√©paratrice ‚Ä¢ Conflit d'√©quipe. √âcoute et m√©diation.</p>
                </div>
                <div class="scenario-card" onclick="selectScenario('demande_augmentation')">
                    <div class="avatar" style="background:linear-gradient(135deg,#fbbf24,#f59e0b);">üí∞</div>
                    <h3>Julie</h3>
                    <p>Adjointe 4 ans ‚Ä¢ Demande d'augmentation. N√©gociation.</p>
                </div>
                <div class="scenario-card" onclick="selectScenario('erreur_delivrance')">
                    <div class="avatar" style="background:linear-gradient(135deg,#fb923c,#f97316);">üò∞</div>
                    <h3>Karim</h3>
                    <p>Pr√©parateur junior ‚Ä¢ Erreur de d√©livrance. Feedback constructif.</p>
                </div>
                <div class="scenario-card" onclick="selectScenario('client_prix_internet')">
                    <div class="avatar" style="background:linear-gradient(135deg,#60a5fa,#3b82f6);">üõí</div>
                    <h3>M. Morel</h3>
                    <p>Client ‚Ä¢ Prix vs internet. Argumenter la valeur ajout√©e.</p>
                </div>
                <div class="scenario-card" onclick="selectScenario('negociation_grossiste')">
                    <div class="avatar" style="background:linear-gradient(135deg,#a78bfa,#7c3aed);">üìä</div>
                    <h3>Fran√ßois</h3>
                    <p>Dir. r√©gional grossiste ‚Ä¢ N√©gociation commerciale annuelle.</p>
                </div>
                <div class="scenario-card" onclick="selectScenario('recadrage_retards')">
                    <div class="avatar" style="background:linear-gradient(135deg,#94a3b8,#64748b);">‚è∞</div>
                    <h3>Thomas</h3>
                    <p>Pr√©parateur ‚Ä¢ Retards r√©p√©t√©s. Recadrage bienveillant.</p>
                </div>
                <div class="scenario-card" onclick="selectScenario('avis_google_negatif')">
                    <div class="avatar" style="background:linear-gradient(135deg,#fca5a5,#f87171);">‚≠ê</div>
                    <h3>Mme Fontaine</h3>
                    <p>Cliente furieuse ‚Ä¢ Avis 1 √©toile. Gestion e-r√©putation.</p>
                </div>
            </div>
        </div>
        <div id="gameContainer" class="game-container">
            <div class="chat-panel">
                <div class="chat-header">
                    <div class="avatar" id="patientAvatar">üë©‚Äçü¶≥</div>
                    <div><p id="chatLabel" style="font-size:10px;opacity:0.7;margin-bottom:2px;">üè• Patient</p><h3 id="patientName">Patient</h3><p id="patientInfo">Info</p></div>
                </div>
                <div id="messages" class="messages"></div>
                <div class="input-area">
                    <div id="suggestions" class="suggestions"></div>
                    <div class="input-row">
                        <input type="text" id="userInput" placeholder="Posez votre question..." onkeypress="if(event.key==='Enter')sendMessage()">
                        <button id="sendBtn" onclick="sendMessage()">Envoyer</button>
                    </div>
                    <div class="actions">
                        <button class="back-btn" onclick="backToSelection()">‚Üê Retour</button>
                        <button class="end-btn" onclick="endSimulation()">üèÅ Terminer</button>
                    </div>
                </div>
            </div>
            <div class="side-panel">
                <div class="panel-card">
                    <h3>üìä Score</h3>
                    <div class="score-value" id="scoreValue">0</div>
                    <div class="score-bar-bg"><div id="scoreBar" class="score-bar" style="width:0%"></div></div>
                </div>
            </div>
        </div>
        <footer>PharmaSim Pro ¬© 2026 Pharmalift Solutions ‚Ä¢ Certification Qualiopi</footer>
    </div>
    <script>
        // === Supabase ===
        const SUPABASE_URL = 'https://lczwfbimzhtpaevjruwu.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxjendmYmltemh0cGFldmpydXd1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkxMDc2NTMsImV4cCI6MjA4NDY4MzY1M30.BCjBDws0yaYInTrrfYJWd_CxA6uQ6YMDmUYATYkr_-I';
        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // === Auth ===
        const Auth = {
            SESSION_KEY: 'pharmasim_session',
            USER_KEY: 'pharmasim_user',

            async validateCode(code) {
                const cleaned = code.toUpperCase().replace(/[^A-Z0-9]/g, '');
                try {
                    const { data: ac, error } = await supabaseClient.from('access_codes').select('*').eq('code', cleaned).eq('is_active', true).single();
                    if (error || !ac) return { valid: false, error: 'Code invalide ou inactif' };
                    if (ac.expires_at && new Date(ac.expires_at) < new Date()) return { valid: false, error: 'Ce code a expir√©' };
                    if (ac.max_uses && ac.current_uses >= ac.max_uses) return { valid: false, error: "Ce code a atteint sa limite d'utilisation" };
                    await supabaseClient.from('access_codes').update({ current_uses: (ac.current_uses || 0) + 1, last_used_at: new Date().toISOString() }).eq('id', ac.id);
                    return { valid: true, codeId: ac.id, accessCode: ac };
                } catch (e) {
                    console.error('Erreur validation:', e);
                    return { valid: false, error: 'Erreur de connexion au serveur' };
                }
            },

            async createSession(codeId, userData) {
                const token = this.generateToken();
                const exp = new Date(); exp.setDate(exp.getDate() + 30);
                try {
                    const { data, error } = await supabaseClient.from('user_sessions').insert({
                        access_code_id: codeId, session_token: token, user_agent: navigator.userAgent, expires_at: exp.toISOString(), is_active: true
                    }).select().single();
                    if (error) throw error;
                    localStorage.setItem(this.SESSION_KEY, token);
                    localStorage.setItem(this.USER_KEY, JSON.stringify({ ...userData, sessionId: data.id, loginAt: new Date().toISOString() }));
                    return { success: true };
                } catch (e) { console.error('Erreur session:', e); return { success: false }; }
            },

            generateToken() {
                const c = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
                let t = ''; for (let i = 0; i < 64; i++) t += c.charAt(Math.floor(Math.random() * c.length)); return t;
            },

            async checkSession() {
                const token = localStorage.getItem(this.SESSION_KEY);
                if (!token) return false;
                try {
                    const { data, error } = await supabaseClient.from('user_sessions').select('*').eq('session_token', token).eq('is_active', true).single();
                    if (error || !data) { this.clearSession(); return false; }
                    if (new Date(data.expires_at) < new Date()) { this.clearSession(); return false; }
                    return true;
                } catch (e) { return false; }
            },

            getUser() { const d = localStorage.getItem(this.USER_KEY); return d ? JSON.parse(d) : null; },

            async logout() {
                const token = localStorage.getItem(this.SESSION_KEY);
                if (token) { try { await supabaseClient.from('user_sessions').update({ is_active: false }).eq('session_token', token); } catch (e) {} }
                this.clearSession();
            },

            clearSession() { localStorage.removeItem(this.SESSION_KEY); localStorage.removeItem(this.USER_KEY); },

            async logUsage(toolFile, action, metadata) {
                const token = localStorage.getItem(this.SESSION_KEY);
                if (!token) return;
                try {
                    const { data: session } = await supabaseClient.from('user_sessions').select('id').eq('session_token', token).single();
                    if (session) {
                        const entry = { session_id: session.id, tool_file: toolFile, action: action };
                        if (metadata) entry.metadata = metadata;
                        await supabaseClient.from('usage_logs').insert(entry);
                    }
                } catch (e) { console.error('Log error:', e); }
            }
        };

        const SCENARIOS = {
            douleur_thoracique: { name: "M. Durand", age: 45, avatar: "‚ö†Ô∏è", info: "Press√©, minimise", suggestions: ["O√π exactement la douleur ?", "Irradiation bras ?", "Essoufflement ?", "Ant√©c√©dents familiaux ?"] },
            femme_enceinte_medicaments: { name: "Mme Laurent", age: 29, avatar: "ü§∞", info: "Enceinte, inqui√®te", suggestions: ["Pris quelque chose ?", "Quel trimestre ?", "Vomissements ?", "Suivi par qui ?"] },
            personne_agee_polymediquee: { name: "Mme Mercier", age: 82, avatar: "üëµ", info: "Confuse, polym√©diqu√©e", suggestions: ["Combien de m√©dicaments ?", "Chutes r√©centes ?", "Vivez seule ?", "Mangez bien ?"] },
            intoxication_enfant: { name: "Mme Girard", age: 30, avatar: "üÜò", info: "Paniqu√©e", suggestions: ["Quel m√©dicament ?", "Combien de comprim√©s ?", "Il y a combien de temps ?", "Poids de l'enfant ?"] },
            mme_dubois: { name: "Mme Dubois", age: 58, avatar: "üë©‚Äçü¶≥", info: "Press√©e mais coop√©rative", suggestions: ["Autres m√©dicaments ?", "Pris quelque chose ce matin ?", "Ant√©c√©dents ?", "D√©crivez la douleur"] },
            aromatherapie: { name: "Mme Martin", age: 42, avatar: "üåø", info: "Anxieuse, cherche du naturel", suggestions: ["Prenez-vous des m√©dicaments ?", "Utilisez d√©j√† des HE ?", "Ant√©c√©dents respiratoires ?", "Allergies cutan√©es ?"] },
            phytotherapie_prostate: { name: "M. Bernard", age: 62, avatar: "üå±", info: "M√©fiant, pr√©f√®re le naturel", suggestions: ["Autres m√©dicaments ?", "Traitement prescrit ?", "Suivi urologique ?", "Sang dans les urines ?"] },
            micronutrition_fatigue: { name: "Mme Faure", age: 35, avatar: "ü•ó", info: "√âpuis√©e, jeune maman", suggestions: ["Vous allaitez ?", "R√©gime alimentaire ?", "Autres sympt√¥mes ?", "R√®gles normales ?"] },
            menopause: { name: "Mme Blanchard", age: 52, avatar: "üå∏", info: "G√™n√©e, bouff√©es de chaleur", suggestions: ["Pourquoi refuser le THS ?", "Prenez des compl√©ments ?", "Sommeil ?", "Ant√©c√©dents familiaux ?"] },
            detox_drainage: { name: "Mme Petit", age: 28, avatar: "üßÉ", info: "Influenc√©e, wellness", suggestions: ["R√©gime alimentaire ?", "Perte de poids r√©cente ?", "Laxatifs ?", "Cheveux, ongles ?"] },
            sport_recuperation: { name: "Thomas", age: 32, avatar: "üèÉ", info: "Sportif motiv√©", suggestions: ["Hydratation ?", "Compl√©ments pris ?", "Crampes ?", "Depuis quand le sport ?"] },
            pediatrie: { name: "M. Petit", age: 35, avatar: "üë∂", info: "P√®re inquiet", suggestions: ["Quelle temp√©rature ?", "D√©j√† donn√© quelque chose ?", "Ant√©c√©dents de Lucas ?", "Combien p√®se-t-il ?"] },
            bebe_coliques: { name: "Mme Dupont", age: 30, avatar: "üë∂", info: "√âpuis√©e, premier b√©b√©", suggestions: ["Allaitement ou biberon ?", "Vu le p√©diatre ?", "R√©gurgitations ?", "Comment vous sentez-vous ?"] },
            personne_agee_isolee: { name: "M. Martin", age: 78, avatar: "üßì", info: "Fier, refuse l'aide", suggestions: ["Vivez seul ?", "Mangez bien ?", "Oubliez vos m√©dicaments ?", "Besoin d'aide au quotidien ?"] },
            femme_enceinte_rhume: { name: "Mme Chen", age: 34, avatar: "ü§ß", info: "Enceinte, enrhum√©e", suggestions: ["Avez-vous de la fi√®vre ?", "Pris quelque chose ?", "Appel√© la sage-femme ?", "Depuis quand ?"] },
            patient_diabetique: { name: "M. Kon√©", age: 58, avatar: "üíâ", info: "Diab√©tique, aime le sucr√©", suggestions: ["√ätes-vous diab√©tique ?", "Sirop sans sucre ?", "Suivi r√©gulier ?", "Pieds, sensations ?"] },
            dermato: { name: "Emma", age: 16, avatar: "üíÜ", info: "Timide, g√™n√©e", suggestions: ["Produits utilis√©s ?", "Type de peau ?", "Routine actuelle ?", "Depuis combien de temps ?"] },
            eczema_bebe: { name: "Mme Dubois-Morel", age: 32, avatar: "üëß", info: "Corticophobie", suggestions: ["Appliquez la cr√®me prescrite ?", "Cr√®mes utilis√©es ?", "Asthme familial ?", "B√©b√© dort bien ?"] },
            mycose_pied: { name: "M. Fernandez", age: 42, avatar: "ü¶∂", info: "G√™n√©, sportif", suggestions: ["Depuis combien de temps ?", "Piscine, sport ?", "Diab√©tique ?", "D√©j√† trait√© ?"] },
            poux: { name: "Mme Martinez", age: 38, avatar: "ü™≥", info: "D√©bord√©e, 3 enfants", suggestions: ["Parents trait√©s aussi ?", "Literie lav√©e ?", "Produit utilis√© ?", "√âcole pr√©venue ?"] },
            coup_de_soleil: { name: "Lucas", age: 22, avatar: "‚òÄÔ∏è", info: "√âtudiant, f√™te plage", suggestions: ["Des cloques ?", "Prenez des m√©dicaments ?", "Cr√®me solaire ?", "Grains de beaut√© ?"] },
            herpes_labial: { name: "Julie", age: 27, avatar: "üíã", info: "Stress√©e, entretien demain", suggestions: ["Fr√©quence des pouss√©es ?", "Quand avez-vous appliqu√© ?", "Contagion, pr√©cautions ?", "Vu un m√©decin ?"] },
            veterinaire: { name: "Mme Rossi", age: 55, avatar: "üê±", info: "Propri√©taire inqui√®te", suggestions: ["Donn√© quelque chose au chat ?", "Vu le v√©t√©rinaire ?", "Perte de poids ?", "Depuis combien de temps ?"] },
            contraception_urgence: { name: "Claire", age: 19, avatar: "üíä", info: "G√™n√©e, stress√©e", suggestions: ["Il y a combien de temps ?", "Contraception habituelle ?", "Cycle r√©gulier ?", "Suivi gyn√©co ?"] },
            test_grossesse_positif: { name: "In√®s", age: 23, avatar: "ü•∫", info: "En pleurs, perdue", suggestions: ["Souhaitez-vous en parler ?", "Entour√©e ?", "Connaissez vos options ?", "Suivi m√©dical ?"] },
            sevrage_tabac: { name: "M. Leroy", age: 55, avatar: "üö¨", info: "Fumeur, sceptique", suggestions: ["Combien par jour ?", "Premi√®re cigarette quand ?", "D√©j√† essay√© quoi ?", "Probl√®mes respiratoires ?"] },
            dependance_benzodiazepines: { name: "Mme Roux", age: 65, avatar: "üò∞", info: "Anxieuse, suppliante", suggestions: ["Depuis combien de temps ?", "Doses augment√©es ?", "Autres somnif√®res ?", "Votre m√©decin en pense quoi ?"] },
            patient_agressif: { name: "M. Sanchez", age: 40, avatar: "üò†", info: "En col√®re", suggestions: ["Depuis quand sans traitement ?", "Sympt√¥mes de manque ?", "On peut chercher une solution", "M√©decin joignable ?"] },
            suspicion_maltraitance: { name: "M√®re de Tim√©o", age: 35, avatar: "üíî", info: "R√©pond √† la place de l'enfant", suggestions: ["Comment c'est arriv√© ?", "D√©j√† arriv√© avant ?", "Tim√©o, tu peux me montrer ?", "D'autres bleus ?"] },
            // Management
            delegue_insistant: { name: "Marc", type: "management", role: "D√©l√©gu√© Pharma G√©n√©rix", avatar: "üëî", info: "Commercial, insistant", suggestions: ["Minimum de commande ?", "Historique de ruptures ?", "Marge r√©elle vs princeps ?", "Pourquoi cette offre maintenant ?"] },
            conflit_equipe: { name: "Sophie", type: "management", role: "Pr√©paratrice", avatar: "üò§", info: "√Ä cran, se sent l√©s√©e", suggestions: ["Depuis combien de temps ?", "Y a-t-il eu des changements r√©cents ?", "Comment vous sentez-vous ?", "Une m√©diation avec Marie ?"] },
            demande_augmentation: { name: "Julie", type: "management", role: "Pharmacienne adjointe (4 ans)", avatar: "üí∞", info: "Fid√®le, argumentaire pr√©par√©", suggestions: ["Des propositions ailleurs ?", "Quelles responsabilit√©s souhaitez-vous ?", "Quel montant envisagez-vous ?", "Comment valoriser votre poste ?"] },
            erreur_delivrance: { name: "Karim", type: "management", role: "Pr√©parateur junior", avatar: "üò∞", info: "Stress√© par son erreur", suggestions: ["L'enfant a-t-il pris le m√©dicament ?", "Premi√®re erreur ?", "V√©rification par le pharmacien ?", "Comment am√©liorer le process ?"] },
            client_prix_internet: { name: "M. Morel", type: "management", role: "Client occasionnel", avatar: "üõí", info: "R√¢leur, compare les prix", suggestions: ["C'est pour qui ce produit ?", "Vous en avez besoin maintenant ?", "Garantie et tra√ßabilit√© ?", "Nos services en plus ?"] },
            negociation_grossiste: { name: "Fran√ßois", type: "management", role: "Dir. r√©gional Alliance Healthcare", avatar: "üìä", info: "Professionnel, en position de force", suggestions: ["Conditions du concurrent ?", "Marge sur la livraison ?", "Autre grossiste m'a contact√©", "N√©gocier le palier ?"] },
            recadrage_retards: { name: "Thomas", type: "management", role: "Pr√©parateur (3 ans)", avatar: "‚è∞", info: "Sympathique mais d√©sinvolte", suggestions: ["Combien de retards ce mois ?", "Impact sur l'√©quipe ?", "Formaliser par √©crit ?", "Solutions propos√©es ?"] },
            avis_google_negatif: { name: "Mme Fontaine", type: "management", role: "Cliente (t√©l√©phone)", avatar: "‚≠ê", info: "Furieuse, veut des excuses", suggestions: ["Que s'est-il pass√© exactement ?", "Vous √™tes cliente depuis longtemps ?", "Je m'excuse sinc√®rement", "On peut se voir pour en discuter ?"] }
        };
        let currentScenario = null, messages = [], score = 0, isTyping = false, simStartTime = null, simMessageCount = 0;

        function selectScenario(id) {
            currentScenario = { id, ...SCENARIOS[id] };
            messages = []; score = 0; simStartTime = Date.now(); simMessageCount = 0;
            Auth.logUsage('pharmasim:' + id, 'pharmasim_start', { scenario_id: id, scenario_name: SCENARIOS[id].name, type: SCENARIOS[id].type || 'patient' });
            const isManagement = currentScenario.type === 'management';
            document.getElementById('patientAvatar').textContent = currentScenario.avatar;
            document.getElementById('patientName').textContent = currentScenario.name;
            document.getElementById('chatLabel').textContent = isManagement ? 'üíº Interlocuteur' : 'üè• Patient';
            document.getElementById('patientInfo').textContent = isManagement ? currentScenario.role + " ‚Ä¢ " + currentScenario.info : currentScenario.age + " ans ‚Ä¢ " + currentScenario.info;
            document.getElementById('suggestions').innerHTML = currentScenario.suggestions.map(s => `<button onclick="useSuggestion('${s.replace(/'/g, "\\'")}')">${s}</button>`).join('');
            document.getElementById('messages').innerHTML = '';
            document.getElementById('scoreValue').textContent = '0';
            document.getElementById('scoreBar').style.width = '0%';
            document.getElementById('scenarioSelection').style.display = 'none';
            document.getElementById('gameContainer').classList.add('active');
            setTimeout(() => sendToAPI("Bonjour, je viens d'arriver."), 500);
        }

        function useSuggestion(text) { document.getElementById('userInput').value = text; }

        function addMessage(type, content) {
            messages.push({ type, content });
            if (type === 'pharmacist') simMessageCount++;
            const avatar = type === 'patient' ? currentScenario.avatar : 'üë®‚Äç‚öïÔ∏è';
            document.getElementById('messages').innerHTML += `<div class="message ${type}"><div class="avatar">${avatar}</div><div class="bubble">${content}</div></div>`;
            document.getElementById('messages').scrollTop = document.getElementById('messages').scrollHeight;
        }

        function showTyping() {
            isTyping = true;
            document.getElementById('sendBtn').disabled = true;
            document.getElementById('messages').innerHTML += `<div id="typing" class="message patient typing"><div class="avatar">${currentScenario.avatar}</div><div class="dots"><span></span><span></span><span></span></div></div>`;
            document.getElementById('messages').scrollTop = document.getElementById('messages').scrollHeight;
        }

        function hideTyping() {
            isTyping = false;
            document.getElementById('sendBtn').disabled = false;
            const t = document.getElementById('typing'); if(t) t.remove();
        }

        async function sendMessage() {
            const input = document.getElementById('userInput');
            const msg = input.value.trim();
            if (!msg || isTyping) return;
            input.value = '';
            addMessage('pharmacist', msg);
            await sendToAPI(msg);
        }

        async function sendToAPI(userMessage) {
            showTyping();
            try {
                const res = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ scenarioId: currentScenario.id, messages, userMessage })
                });
                const data = await res.json();
                hideTyping();
                if (data.response) {
                    addMessage('patient', data.response);
                    updateScore(userMessage, data.response);
                }
            } catch (e) {
                hideTyping();
                addMessage('patient', "Pardon, pouvez-vous r√©p√©ter ?");
            }
        }

        function updateScore(q, a) {
            const ql = q.toLowerCase(), al = a.toLowerCase();
            let points = 0;
            // M√©dicaments cach√©s
            if ((ql.includes('autre') && ql.includes('m√©dicament')) || ql.includes('traitement') || ql.includes('prenez')) {
                if (al.includes('kard√©gic') || al.includes('lexomil') || al.includes('cardiologue') || al.includes('tamsulosine') || al.includes('arr√™t√©') || al.includes('metformine') || al.includes('acide folique') || al.includes('stilnox') || al.includes('antid√©presseur') || al.includes('pilule')) points += 25;
            }
            // Autom√©dication
            if (ql.includes('pris') || ql.includes('donn√©') || ql.includes('autom√©dication') || ql.includes('utilis√©') || ql.includes('appliqu√©')) {
                if (al.includes('advil') || al.includes('ibuprof√®ne') || al.includes('doliprane') || al.includes('internet') || al.includes('tiktok') || al.includes('√©cras√©') || al.includes('p√¢t√©e') || al.includes('laxatif') || al.includes('p√©rim√©') || al.includes('mayonnaise') || al.includes('grog') || al.includes('alcool') || al.includes('sirop') || al.includes('prot√©ine') || al.includes('soja')) points += 20;
            }
            // Ant√©c√©dents
            if (ql.includes('ant√©c√©dent') || ql.includes('pass√©') || ql.includes('famil') || ql.includes('d√©j√† eu')) {
                if (al.includes('ulc√®re') || al.includes('asthme') || al.includes('convulsion') || al.includes('infarctus') || al.includes('p√®re') || al.includes('d√©c√©d√©') || al.includes('cancer') || al.includes('bpco') || al.includes('diab√®t')) points += 20;
            }
            // Allergies
            if (ql.includes('allergie')) points += 10;
            // Allaitement / grossesse
            if (ql.includes('allait') || ql.includes('enceinte') || ql.includes('b√©b√©') || ql.includes('nourri') || ql.includes('trimestre')) {
                if (al.includes('allait') || al.includes('b√©b√©') || al.includes('4 mois') || al.includes('enceinte') || al.includes('mois')) points += 25;
            }
            // R√©gime alimentaire
            if (ql.includes('r√©gime') || ql.includes('alimenta') || ql.includes('mange') || ql.includes('nutrition')) {
                if (al.includes('v√©g√©tari') || al.includes('viande') || al.includes('conserve') || al.includes('je√ªne') || al.includes('peu')) points += 20;
            }
            // Sympt√¥mes sp√©cifiques
            if (ql.includes('r√®gle') || ql.includes('cheveu') || ql.includes('perte') || ql.includes('ongle')) {
                if (al.includes('r√®gle') || al.includes('abondant') || al.includes('cheveu') || al.includes('cassant')) points += 20;
            }
            // Urgence cardiaque
            if ((ql.includes('irrad') || ql.includes('bras')) && al.includes('bras')) points += 25;
            if (ql.includes('essouffle') && (al.includes('essouffle') || al.includes('souffle'))) points += 20;
            if (ql.includes('fum') && (al.includes('fum') || al.includes('paquet'))) points += 15;
            // R√©orientation urgence/m√©decin
            if (ql.includes('urgence') || ql.includes('h√¥pital') || ql.includes('15') || ql.includes('samu') || ql.includes('antipoison') || ql.includes('114')) points += 25;
            if (ql.includes('m√©decin') || ql.includes('sage-femme') || ql.includes('gyn√©co') || ql.includes('p√©diatre') || ql.includes('planning')) points += 15;
            // V√©t√©rinaire
            if (ql.includes('v√©t√©rinaire') || ql.includes('v√©to')) {
                if (al.includes('v√©to') || al.includes('2 ans') || al.includes('pas vu')) points += 20;
            }
            // Prostate / suivi
            if ((ql.includes('psa') || (ql.includes('prostate') && ql.includes('contr√¥l')) || ql.includes('urolog'))) {
                if (al.includes('psa') || al.includes('contr√¥l') || al.includes('3 ans') || al.includes('sang')) points += 25;
            }
            // Diab√®te et terrain
            if (ql.includes('diab√®t') || ql.includes('sucre') || ql.includes('glyc√©mi')) {
                if (al.includes('diab√®t') || al.includes('metformine') || al.includes('sucr')) points += 20;
            }
            // Cloques / gravit√©
            if (ql.includes('cloque') || ql.includes('gravit√©') || ql.includes('degr√©')) {
                if (al.includes('cloque') || al.includes('2√®me')) points += 20;
            }
            // Photosensibilisation
            if ((ql.includes('antibiotique') || ql.includes('m√©dicament')) && al.includes('doxycycline')) points += 25;
            // Contagion herp√®s
            if (ql.includes('contagi') || ql.includes('embrass')) {
                if (al.includes('embrass') || al.includes('copain') || al.includes('contagi')) points += 20;
            }
            // Fr√©quence r√©cidives
            if (ql.includes('fr√©quen') || ql.includes('combien de fois') || ql.includes('r√©cidiv')) {
                if (al.includes('fois') || al.includes('an') || al.includes('r√©cidiv')) points += 15;
            }
            // D√©pendance / sevrage
            if (ql.includes('depuis') && (ql.includes('combien') || ql.includes('quand') || ql.includes('longtemps'))) {
                if (al.includes('15 ans') || al.includes('35 ans') || al.includes('2 jours') || al.includes('3 mois')) points += 15;
            }
            // Literie / environnement poux
            if (ql.includes('liter') || ql.includes('doudou') || ql.includes('drap') || ql.includes('parent')) {
                if (al.includes('liter') || al.includes('doudou') || al.includes('parent') || al.includes('lav√©')) points += 20;
            }
            // Cortisone / observance
            if (ql.includes('cortisone') || ql.includes('cr√®me prescrit') || ql.includes('appliqu')) {
                if (al.includes('peur') || al.includes('pas appliqu') || al.includes('naturel') || al.includes('cortisone')) points += 20;
            }
            // Maltraitance
            if (ql.includes('bleu') || ql.includes('chute') || ql.includes('escalier') || ql.includes('d√©j√† arriv√©')) {
                if (al.includes('3√®me fois') || al.includes('tomb√©') || al.includes('strict') || al.includes('beau-p√®re')) points += 25;
            }
            // D√©sescalade
            if (ql.includes('comprend') || ql.includes('solution') || ql.includes('aide') || ql.includes('calme')) points += 10;

            // --- MANAGEMENT SCORING ---
            // D√©l√©gu√© insistant
            if ((ql.includes('minimum') || ql.includes('quantit√©')) && (al.includes('500') || al.includes('minimum'))) points += 25;
            if ((ql.includes('rupture') || ql.includes('approvisionnement') || ql.includes('disponib')) && (al.includes('rupture') || al.includes('stock'))) points += 20;
            if (ql.includes('marge') && (al.includes('marge') || al.includes('inf√©rieur') || al.includes('princeps'))) points += 25;
            if ((ql.includes('objectif') || (ql.includes('pourquoi') && ql.includes('offre'))) && (al.includes('objectif') || al.includes('concurrent'))) points += 20;
            // Conflit √©quipe
            if ((ql.includes('promotion') || ql.includes('poste') || ql.includes('changement')) && (al.includes('promotion') || al.includes('esp√©rai') || al.includes('poste'))) points += 25;
            if ((ql.includes('personnel') || ql.includes('comment vous') || ql.includes('vous sentez')) && (al.includes('divorce') || al.includes('personnel') || al.includes('difficile'))) points += 25;
            if (ql.includes('m√©diation') || ql.includes('ensemble') || (ql.includes('rencontr') && ql.includes('marie'))) points += 20;
            // Demande augmentation
            if ((ql.includes('offre') || ql.includes('ailleurs') || ql.includes('propos√©')) && (al.includes('offre') || al.includes('autre pharmacie') || al.includes('300'))) points += 25;
            if ((ql.includes('responsabilit') || ql.includes('√©volution') || ql.includes('mission')) && (al.includes('responsabilit') || al.includes('formation'))) points += 20;
            if ((ql.includes('valoris') || ql.includes('garder') || ql.includes('arrangement') || ql.includes('alternative'))) points += 15;
            // Erreur d√©livrance
            if ((ql.includes('v√©rifi') || ql.includes('pharmacien') || ql.includes('contr√¥le')) && (al.includes('t√©l√©phone') || al.includes('v√©rifi') || al.includes('pharmacien'))) points += 25;
            if ((ql.includes('premi√®re fois') || ql.includes('d√©j√† arriv√©') || ql.includes('premi√®re erreur')) && (al.includes('premi√®re') || al.includes('jamais'))) points += 15;
            if (ql.includes('process') || ql.includes('proc√©dure') || ql.includes('am√©liorer') || ql.includes('√©viter')) points += 20;
            // Client prix internet
            if ((ql.includes('pour qui') || ql.includes('enfant') || ql.includes('urgent') || ql.includes('besoin')) && (al.includes('br√ªl') || al.includes('enfant') || al.includes('maintenant'))) points += 25;
            if (ql.includes('contrefa√ßon') || ql.includes('garanti') || ql.includes('tra√ßabilit') || ql.includes('authentici')) points += 20;
            if (ql.includes('conseil') || ql.includes('service') || ql.includes('valeur ajout√©')) points += 15;
            // N√©gociation grossiste
            if ((ql.includes('concurrent') || ql.includes('condition')) && (al.includes('concurrent') || al.includes('meilleur') || al.includes('condition'))) points += 20;
            if ((ql.includes('livraison') || ql.includes('fr√©quence')) && (al.includes('livraison') || al.includes('n√©goci'))) points += 20;
            if ((ql.includes('autre grossiste') || ql.includes('approch√©') || ql.includes('proposition')) && (al.includes('approch√©') || al.includes('grossiste'))) points += 25;
            // Recadrage retards
            if ((ql.includes('combien') && ql.includes('retard')) && (al.includes('4') || al.includes('retard'))) points += 15;
            if ((ql.includes('√©quipe') || ql.includes('coll√®gue') || ql.includes('impact')) && (al.includes('agac') || al.includes('remarqu') || al.includes('√©quipe'))) points += 20;
            if (ql.includes('formaliser') || ql.includes('√©crit') || ql.includes('avertissement') || ql.includes('entretien')) points += 20;
            // Avis Google n√©gatif
            if (ql.includes('excus') || ql.includes('d√©sol√©') || ql.includes('pardon')) points += 15;
            if ((ql.includes('informatique') || ql.includes('probl√®me') || ql.includes('panne')) && (al.includes('informatique') || al.includes('probl√®me') || al.includes('panne'))) points += 20;
            if (((ql.includes('client') || ql.includes('fid√®le')) && ql.includes('depuis')) && (al.includes('20 ans') || al.includes('fid√®le'))) points += 20;
            if (ql.includes('avis') && (ql.includes('modifier') || ql.includes('retirer') || ql.includes('changer'))) points += 15;

            if (points > 0) {
                score += points;
                document.getElementById('scoreValue').textContent = score;
                document.getElementById('scoreBar').style.width = Math.min(score, 100) + '%';
            }
        }

        function endSimulation() {
            const duration = simStartTime ? Math.round((Date.now() - simStartTime) / 1000) : 0;
            Auth.logUsage('pharmasim:' + currentScenario.id, 'pharmasim_complete', {
                scenario_id: currentScenario.id, scenario_name: currentScenario.name,
                type: currentScenario.type || 'patient', score: score,
                message_count: simMessageCount, duration_seconds: duration
            });
            let feedback = score >= 80 ? "üèÜ Excellent travail ! Questionnement complet et pertinent." : score >= 50 ? "üëç Bon travail, mais quelques pistes de questionnement manqu√©es." : score >= 25 ? "‚ö†Ô∏è Plusieurs √©l√©ments importants n'ont pas √©t√© explor√©s." : "‚ùå Beaucoup d'informations critiques non d√©tect√©es. Reprenez le sc√©nario !";
            addMessage('patient', `[Fin de simulation]\n\n${feedback}\n\nScore: ${score} points`);
        }

        function backToSelection() {
            document.getElementById('scenarioSelection').style.display = 'block';
            document.getElementById('gameContainer').classList.remove('active');
        }

        // === Login / Logout / Init ===
        function formatCodeInput(input) {
            let v = input.value.toUpperCase().replace(/[^A-Z0-9]/g, '');
            let f = '';
            for (let i = 0; i < v.length && i < 12; i++) {
                if (i > 0 && i % 4 === 0) f += '-';
                f += v[i];
            }
            input.value = f;
        }

        function showApp(user) {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('scenarioSelection').style.display = 'block';
            if (user && (user.prenom || user.nom || user.email)) {
                const badge = document.getElementById('userBadge');
                badge.textContent = user.prenom ? (user.prenom + ' ' + user.nom).trim() : user.email;
                badge.style.display = 'block';
            }
            document.getElementById('logoutBtn').style.display = 'block';
        }

        async function handleLogin() {
            const codeInput = document.getElementById('accessCode');
            const errorDiv = document.getElementById('loginError');
            const loginBtn = document.getElementById('loginBtn');
            const code = codeInput.value.toUpperCase().replace(/[^A-Z0-9]/g, '');
            if (code.length !== 12) {
                errorDiv.textContent = 'Veuillez entrer un code valide (12 caract√®res)';
                errorDiv.style.display = 'block'; return;
            }
            loginBtn.disabled = true; loginBtn.textContent = 'V√©rification...';
            errorDiv.style.display = 'none';
            const result = await Auth.validateCode(code);
            if (result.valid) {
                const ac = result.accessCode;
                const userData = { prenom: ac.prenom || '', nom: ac.nom || '', email: ac.email || '', etablissement: ac.etablissement || '', codeId: ac.id };
                const session = await Auth.createSession(result.codeId, userData);
                if (session.success) { showApp(userData); }
                else { errorDiv.textContent = 'Erreur de connexion. R√©essayez.'; errorDiv.style.display = 'block'; }
            } else {
                errorDiv.textContent = result.error; errorDiv.style.display = 'block';
            }
            loginBtn.disabled = false; loginBtn.textContent = 'Acc√©der aux simulations';
        }

        async function handleLogout() {
            await Auth.logout();
            document.getElementById('scenarioSelection').style.display = 'none';
            document.getElementById('gameContainer').classList.remove('active');
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('userBadge').style.display = 'none';
            document.getElementById('logoutBtn').style.display = 'none';
            document.getElementById('accessCode').value = '';
        }

        // === Init ===
        (async function initApp() {
            const hasSession = await Auth.checkSession();
            if (hasSession) {
                showApp(Auth.getUser());
            } else {
                document.getElementById('loginScreen').style.display = 'flex';
            }
        })();
    </script>
</body>
</html>
